{% extends "base.html" %}
{% block title %}饭否 10 周年投票{% endblock %}
{% block content %}
<nav class="light-blue">
    <div class="container">
        <div class="nav-wrapper">
            <ul class="right">
                <li>您好！@{{ nickname or '匿名用户' }}</li>
                <li><a href="/logout">登出</a></li>
            </ul>
            <span class="title">饭否十周年 T 恤投票</span>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        {% for i in data %}
        <div class="col s12 m6 l6">
            <a href="#modal-{{ loop.index0 }}">
                <div class="card">
                    <div class="card-image">
                        <img src="{{ i['img'][0] }}" alt="{{ i['name'] }}">
                        <div class="card-check">
                            <a class="waves-effect waves-light btn light-blue darken-2 btn-square btn-vote" href="#!" data-product-id="{{ i['id'] }}">
                                <i class="material-icons">{% if voted[i['id']] %}remove{% else %}add{% endif %}</i>
                            </a>
                        </div>
                        <span class="card-name">{{ i['name'] }}</span>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
</div>

{% for i in data %}
<div id="modal-{{ loop.index0 }}" class="modal">
    <div class="carousel-row">
        {% for img in i['img'] %}
        <a href="{{ img }}" target="_blank"><img src="{{ img }}"></a>
        {% endfor %}
    </div>
    <div class="modal-content">
      <a class="btn-floating btn-vote btn-large btn-carousel-middle waves-effect waves-light light-blue" data-product-id="{{ i['id'] }}">
          <i class="material-icons">{% if voted[i['id']] %}remove{% else %}add{% endif %}</i>
      </a>
      <h4>{{ i['name'] }}</h4>
      <p>{{ i['desc'] }}</p>
    </div>
</div>
{% endfor %}

<script type="text/javascript">
    $(document).ready(function(){
        $('.modal').modal();
        window.voted = {{ voted|tojson }};

        $(".btn-vote").click(function(){
            var product_id = $(this).data("product-id");
            var result = voted[product_id]
            var action = result ? 'undo' : 'vote';

            // TODO: replace with your own API.
            $.ajax("/products/" + product_id +  "/" + action, {method: "POST"})
             .done(function(data){
                 if (data.success) {
                     window.voted[product_id] = !result;
                     $(".btn-vote[data-product-id=" + product_id + "]").find("i").text(voted[product_id] ? "remove" : "add");
                     Materialize.toast(!result ? '投票成功！' : '撤票成功！', 4000);
                 } else {
                     Materialize.toast((!result ? '投票失败：' : '撤票失败：') + data.error, 4000, "red darken-4");
                 }
             })
             .fail(function(xhr, text){
                Materialize.toast((!result ? '投票失败：' : '撤票失败：') + text, 4000, "red darken-4");
             });
        });
    });
</script>
{% endblock %}
